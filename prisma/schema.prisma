generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model StockDevice {
  id           Int      @id @default(autoincrement())
  deviceId     String   @unique
  serialNumber String   @unique
  createdAt    DateTime @default(now())
  lotNo        String
  companyName  String
}

model Device {
  id           Int          @id @default(autoincrement())
  deviceId     String       @unique
  serialNumber String       @unique
  model        String
  name         String       @default("")
  registeredAt DateTime     @default(now())
  isActive     Boolean      @default(true) // เป็น สถานะบอกว่าอปุปกรณ์นี้ connect , disconnect
  dataRecords  DataRecord[]
  userId       String?
  User         User?        @relation(name: "UserDevices", fields: [userId], references: [id])

  currentValue Float?
  currentUnit  String?
  currentAt    DateTime?
  status       String?   @default("new") // 'new', 'Owner', 'changeOwner', 'repair', 'failer'

  //  'changeOwner', 'repair', 'failed' Admin ทำ

  isSyncInfo  Boolean            @default(false)
  deletedAt   DateTime?
  latestState DeviceLatestState?
}

model DataRecord {
  id           Int      @id @default(autoincrement())
  device       Device   @relation(fields: [deviceId], references: [id])
  deviceId     Int
  timestamp    DateTime
  value        Float
  unit         String
  recordNumber Int
  serialNumber String   @default("")
  rawData      String   @default("")
  sessionId    String   @default("")
  time_text    String   @default("") // for display
  timeUpdate   DateTime @default(now())
  buffer       String?  @default("")
}

model User {
  id          String        @id @default(uuid())
  name        String
  email       String        @unique
  password    String
  createdAt   DateTime      @default(now())
  deletedAt   DateTime?
  devices     Device[]      @relation(name: "UserDevices")
  provider    String        @default("local")
  dateOfBirth DateTime?
  username    String?
  lastName    String?
  role        String?       @default("User") // 'User', 'Admin', 'SuperAdmin'
  consents    UserConsent[]
}

enum ConsentType {
  privacy
  terms
  cookie
}

enum AcceptedBy {
  web
  ios
  android
  api
}

model UserConsent {
  id            BigInt      @id @default(autoincrement()) @db.UnsignedBigInt
  userId        String      @map("user_id") @db.VarChar(191)
  consentType   ConsentType @map("consent_type")
  policyVersion String      @map("policy_version") @db.VarChar(20)
  acceptedAt    DateTime    @map("accepted_at") @db.DateTime(3)
  acceptedBy    AcceptedBy  @default(web) @map("accepted_by")
  ipAddress     String?     @map("ip_address") @db.VarChar(45)
  userAgent     String?     @map("user_agent") @db.VarChar(255)
  createdAt     DateTime    @default(now()) @map("created_at") @db.Timestamp(0)
  updatedAt     DateTime?   @updatedAt @map("updated_at") @db.Timestamp(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, consentType, policyVersion], map: "uq_user_consent")
  @@index([userId], map: "idx_user_id")
  @@index([consentType], map: "idx_consent_type")
  @@map("user_consents")
}

model AdminUser {
  id        Int      @id @default(autoincrement())
  name      String
  username  String   @unique
  password  String
  isActive  Boolean  @default(true)
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DeviceLatestState {
  id Int @id @default(autoincrement())

  // เชื่อมกับ Device (1-to-1)
  deviceId Int    @unique
  device   Device @relation(fields: [deviceId], references: [id], onDelete: Cascade)

  // ข้อมูลที่ใช้คำนวณ Logic ตัด Session
  timestamp    DateTime
  recordNumber Int
  sessionId    String

  updatedAt DateTime @updatedAt // อัปเดตอัตโนมัติเมื่อมีข้อมูลใหม่เข้า
}
